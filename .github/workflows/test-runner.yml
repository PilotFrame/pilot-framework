name: Adapter Sandbox Test Runner

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "adapter-template/**"
      - "sandbox-runner/**"
      - ".github/workflows/test-runner.yml"

jobs:
  sandbox-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ADAPTER_IMAGE: pf-sandbox/seo-adapter:pr-${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build Adapter Image
        run: |
          cd adapter-template
          npm ci
          npm run build
          docker build -t $ADAPTER_IMAGE .

      - name: Start Sandbox Runner
        run: |
          cd sandbox-runner
          npm ci
          npm run build
          node dist/index.js &
          echo $! > ../sandbox-runner.pid
          sleep 5

      - name: Execute Sandbox Run
        run: |
          cat <<'EOF' > payload.json
          {
            "image": "${ADAPTER_IMAGE}",
            "method": "seo.evaluate_content",
            "input": {
              "draft": "This is a sample draft detailing technical SEO audit steps and performance considerations.",
              "target_keyword": "technical seo audit checklist",
              "business_goal": "leads",
              "secondary_keywords": ["seo audit", "page experience"],
              "competitors": ["example.com"]
            },
            "cpu": 1,
            "memory": "2g",
            "timeoutSeconds": 120
          }
          EOF
          curl -sSf -X POST http://localhost:4200/run \
            -H "content-type: application/json" \
            -d @payload.json | tee sandbox-output.json

      - name: Print Sandbox Summary
        run: |
          cat sandbox-output.json | jq '{status, exitCode, durationMs, output}'

      - name: Upload Sandbox Logs
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-runner-logs
          path: sandbox-output.json

      - name: Cleanup
        if: always()
        run: |
          if [ -f sandbox-runner.pid ]; then
            kill $(cat sandbox-runner.pid) || true
          fi
          docker rm -f $(docker ps -aq --filter "ancestor=$ADAPTER_IMAGE") 2>/dev/null || true
          docker image rm $ADAPTER_IMAGE 2>/dev/null || true

